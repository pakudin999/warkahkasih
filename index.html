import React, { useState, useCallback, memo, useEffect, useRef } from 'react';
import { Info, Copy, Check, X, Loader2, Upload, Sparkles, Heart, Camera, Aperture, RefreshCw, Layers, User, ScanFace, Lock, Unlock, Power, ShieldAlert, Settings, Key, Eye, EyeOff, Save, AlertTriangle, LogOut, Mail, KeyRound, Globe } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signInWithEmailAndPassword, signOut } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, setDoc, collection } from 'firebase/firestore';
import { getAnalytics } from "firebase/analytics";

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyDGqC3uAK_uNxrZEi6HSC3MFx0uCKYIHyI",
  authDomain: "warkahkasih-f5c6c.firebaseapp.com",
  projectId: "warkahkasih-f5c6c",
  storageBucket: "warkahkasih-f5c6c.firebasestorage.app",
  messagingSenderId: "1070841752082",
  appId: "1:1070841752082:web:2dc4b46db950188c2446cb",
  measurementId: "G-HK8Q2J53TM"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Analytics Safe Init
let analytics;
try {
  if (typeof window !== 'undefined') analytics = getAnalytics(app);
} catch (e) { console.log("Analytics skipped"); }

const appId = typeof __app_id !== 'undefined' ? __app_id : 'warkahkasih-f5c6c';

// --- MOCK SERVICES ---
const fileToBase64 = (file) => new Promise((resolve, reject) => {
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onload = () => resolve(reader.result);
  reader.onerror = (error) => reject(error);
});

const generateStyleAnalysisPrompt = async (base64Data, mimeType, apiKey) => {
  console.log("API Key Status:", apiKey ? "OK" : "Missing"); 
  await new Promise(resolve => setTimeout(resolve, 2000));
  return `A hyper-realistic wedding masterpiece featuring a luxurious and romantic aesthetic. The scene radiates soft elegance with a cinematic dreamy atmosphere, creamy pastels, champagne gold, and soft whites. Lighting features exquisite golden hour backlighting mixed with soft diffused window light. Composition utilizes center symmetrical framing with shallow depth of field (bokeh). 8k resolution, photorealistic, shot on Sony A7R V with 85mm f/1.2 GM lens.`;
};

const generateBatchPosePrompts = async (base64Data, mimeType, apiKey) => {
  await new Promise(resolve => setTimeout(resolve, 3000));
  const baseStyle = "luxurious romantic aesthetic, soft pastel palette, cinematic golden hour lighting, 8k photorealistic";
  return [
    { title: "Candid: The Joyful Walk", prompt: `Candid medium shot of couple laughing naturally while walking, holding hands, movement blur, joyful atmosphere, confetti, ${baseStyle} --ar 3:4 --v 6.0` },
    { title: "Intimate: Forehead Touch", prompt: `Intimate close-up touching foreheads, eyes closed, peaceful expression, soft side lighting, emotional connection, shallow depth of field, ${baseStyle} --ar 3:4 --v 6.0` },
    { title: "Artistic: Under The Veil", prompt: `Dreamy artistic shot under the bride's veil covering both, soft diffused glowing light, intimate moment, focus on eyes, ${baseStyle} --ar 3:4 --v 6.0` },
    { title: "Wide: Tiny People Big World", prompt: `Epic wide angle environmental shot, small couple against grand architectural backdrop, dramatic sky, symmetrical Wes Anderson style, ${baseStyle} --ar 16:9 --v 6.0` },
    { title: "Classic: The Hollywood Dip", prompt: `Classic romantic pose groom dips bride, dramatic silhouette against sunset, elegant body language, cinematic composition, ${baseStyle} --ar 3:4 --v 6.0` },
    { title: "Detail: Hand Holding", prompt: `Macro detail shot of interlaced hands, showing rings and songket fabric texture, soft focus background, ${baseStyle} --ar 3:4 --v 6.0` },
    { title: "Candid: Secret Whisper", prompt: `Groom whispering to bride, her shy smile, looking down, natural lighting, side profile, genuine reaction, ${baseStyle} --ar 3:4 --v 6.0` },
    { title: "Mood: B&W Emotion", prompt: `High contrast Black and White portrait, grainy film look, focus on raw emotion and teary eyes, timeless nostalgic mood, ${baseStyle} --ar 3:4 --v 6.0` }
  ];
};

// --- UI COMPONENTS ---
const InfoButton = ({ title, children }) => {
  const [isOpen, setIsOpen] = useState(false);
  return (
    <div className="relative inline-block">
      <button type="button" onClick={() => setIsOpen(!isOpen)} className="text-slate-400 hover:text-amber-400 p-2 rounded-full hover:bg-slate-800 transition-colors"><Info size={20} /></button>
      {isOpen && (
        <>
          <div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)}></div>
          <div className="absolute right-0 mt-2 w-72 bg-slate-900 border border-slate-700 p-5 rounded-xl shadow-2xl z-20 text-left backdrop-blur-md bg-opacity-95">
            <h4 className="text-amber-400 font-bold mb-3 text-sm tracking-wide flex items-center gap-2"><Sparkles size={14} /> {title}</h4>
            <div className="text-xs text-slate-300 space-y-3 leading-relaxed">{children}</div>
          </div>
        </>
      )}
    </div>
  );
};

const CopyButton = ({ textToCopy, label = "Salin" }) => {
  const [copied, setCopied] = useState(false);
  const handleCopy = () => {
    if (!textToCopy) return;
    const textArea = document.createElement("textarea");
    textArea.value = textToCopy;
    textArea.style.position = "fixed"; textArea.style.left = "-9999px";
    document.body.appendChild(textArea);
    textArea.focus(); textArea.select();
    try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (err) { console.error(err); }
    document.body.removeChild(textArea);
  };
  return (
    <button onClick={handleCopy} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all font-medium text-[10px] tracking-wider uppercase ${copied ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 hover:border-amber-500/30 hover:text-amber-400'}`}>
      {copied ? <><Check size={12} /> {label}</> : <><Copy size={12} /> {label}</>}
    </button>
  );
};

const ImageUploadArea = ({ uploadedFile, isDragging, onDragOver, onDragLeave, onDrop, onClick, fileInputRef, handleFile, onRemove }) => (
  <div onClick={onClick} onDragOver={onDragOver} onDragLeave={onDragLeave} onDrop={onDrop} className={`relative group bg-slate-900/40 rounded-xl p-4 text-center border border-dashed transition-all duration-300 min-h-[160px] flex flex-col items-center justify-center cursor-pointer overflow-hidden hover:bg-slate-800/60 ${isDragging ? 'border-amber-500 bg-slate-800/80 ring-2 ring-amber-500/20' : 'border-slate-700 hover:border-amber-500/40'} ${uploadedFile ? 'border-none p-0 h-auto min-h-0' : ''}`}>
    {uploadedFile ? (
        <div className="relative w-full">
            <img src={uploadedFile.previewUrl} alt="Preview" className="w-full h-64 object-contain rounded-lg bg-black/20" />
            <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                <span className="text-white text-xs font-medium bg-black/50 px-4 py-2 rounded-full backdrop-blur-md border border-white/10">Klik untuk tukar</span>
            </div>
            <button type="button" onClick={onRemove} className="absolute top-2 right-2 bg-slate-900/80 hover:bg-red-500 text-white rounded-full p-1.5 shadow-lg transition-colors z-30 border border-white/10" title="Buang gambar"><X size={14} /></button>
        </div>
    ) : (
        <div className="pointer-events-none z-10 flex flex-col items-center gap-3">
            <div className="p-3 bg-slate-800 rounded-full text-slate-400 group-hover:text-amber-500 shadow-md group-hover:shadow-amber-500/20 transition-all duration-300 border border-slate-700 group-hover:border-amber-500/30"><Upload size={20} /></div>
            <div className="space-y-0.5"><p className="text-sm font-medium text-slate-300 group-hover:text-white transition-colors">Muat Naik Gambar</p><p className="text-[10px] text-slate-500 uppercase tracking-widest">Klik atau Tarik (JPG/PNG)</p></div>
        </div>
    )}
    <input ref={fileInputRef} type="file" className="hidden" accept="image/jpeg,image/png,image/webp" onChange={(e) => handleFile(e.target.files[0])} />
  </div>
);

// --- TAB COMPONENTS ---
const StyleAnalyzerTab = memo(({ showModal, showLoadingModal, hideLoadingModal, formData, setFormData, onReset, config }) => {
    const [isDragging, setIsDragging] = useState(false);
    const fileInputRef = useRef(null);
    const { uploadedFile, generatedPrompt } = formData;
    const apiEnabled = config?.apiEnabled;
    const apiKey = config?.apiKey;

    const handleFile = useCallback((file) => {
        if (!file) return;
        if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) { showModal('Format Tidak Sah', 'Sila muat naik fail gambar JPG atau PNG sahaja.'); return; }
        if (uploadedFile) URL.revokeObjectURL(uploadedFile.previewUrl);
        setFormData((prev) => ({...prev, uploadedFile: { file, previewUrl: URL.createObjectURL(file) }}));
    }, [showModal, uploadedFile, setFormData]);

    const handleRemove = (e) => { e.stopPropagation(); setFormData((prev) => ({...prev, uploadedFile: null, generatedPrompt: '' })); };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!apiEnabled) { showModal('Sistem Diselenggara', 'Maaf, servis AI sedang dimatikan oleh Admin untuk penyelenggaraan.'); return; }
        if (!uploadedFile) { showModal('Tiada Gambar', 'Sila muat naik gambar rujukan gaya kahwin terlebih dahulu.'); return; }
        showLoadingModal('Analisis Gaya...', 'AI sedang membaca tekstur, pencahayaan, dan mood...');
        setFormData((prev) => ({...prev, generatedPrompt: ''}));
        try {
            const base64ImageData = await fileToBase64(uploadedFile.file);
            const prompt = await generateStyleAnalysisPrompt(base64ImageData, uploadedFile.file.type, apiKey);
            setFormData((prev) => ({...prev, generatedPrompt: prompt}));
        } catch (error) { showModal('Ralat', 'Sistem gagal memproses gambar.'); } finally { hideLoadingModal(); }
    };

    return (
        <div className="animate-in slide-in-from-right-5 duration-500">
             <div className="flex justify-between items-center mb-6 px-1">
                <h3 className="text-lg font-serif text-slate-200">Analisis Style & Tone</h3>
                <InfoButton title="Info Analisis"><p>AI akan menganalisis estetik gambar (warna, lighting, mood) dan menghasilkan satu prompt utama untuk ditiru.</p></InfoButton>
            </div>
            <form onSubmit={handleSubmit} className="space-y-6">
                <ImageUploadArea uploadedFile={uploadedFile} isDragging={isDragging} onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }} onDragLeave={(e) => { e.preventDefault(); setIsDragging(false); }} onDrop={(e) => { e.preventDefault(); setIsDragging(false); handleFile(e.dataTransfer.files[0]); }} onClick={() => fileInputRef.current?.click()} fileInputRef={fileInputRef} handleFile={handleFile} onRemove={handleRemove} />
                <div className="flex flex-col sm:flex-row gap-3 pt-1">
                    <button type="submit" disabled={!uploadedFile} className={`flex-1 w-full bg-gradient-to-r ${apiEnabled ? 'from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600' : 'from-slate-700 to-slate-800 cursor-not-allowed grayscale'} disabled:opacity-70 text-white font-bold py-3.5 px-6 rounded-xl transition-all duration-300 ease-out flex items-center justify-center gap-2 shadow-lg shadow-amber-900/20 hover:shadow-amber-500/20 hover:-translate-y-0.5 group text-sm`}>
                        {uploadedFile ? <Sparkles size={18} className="animate-pulse" /> : <Aperture size={18} />}
                        <span className="tracking-wide">{apiEnabled ? 'ANALISIS STYLE' : 'SYSTEM OFFLINE'}</span>
                    </button>
                    <button type="button" onClick={onReset} className="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white font-medium py-3.5 px-4 rounded-xl transition duration-300 border border-slate-700 hover:border-slate-500"><RefreshCw size={18} /></button>
                </div>
            </form>
            {generatedPrompt && (
                <div className="mt-10 animate-in slide-in-from-bottom-10 duration-700">
                    <div className="flex items-center justify-between mb-3"><h2 className="text-sm font-serif text-white flex items-center gap-2"><Check className="text-emerald-500" size={16} /> Prompt Hasil Analisis</h2><span className="text-[10px] uppercase tracking-widest text-slate-500">AI Model v6.0</span></div>
                    <div className="relative bg-slate-900/80 rounded-xl p-1 border border-slate-700/50 shadow-2xl backdrop-blur-sm overflow-hidden group">
                        <div className="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-50"></div>
                        <textarea value={generatedPrompt} className="w-full bg-transparent border-0 text-slate-300 focus:ring-0 resize-none p-5 font-mono text-xs md:text-sm leading-loose" rows={8} readOnly />
                        <div className="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300"><CopyButton textToCopy={generatedPrompt} label="SALIN" /></div>
                    </div>
                </div>
            )}
        </div>
    );
});

const PoseGeneratorTab = memo(({ showModal, showLoadingModal, hideLoadingModal, formData, setFormData, onReset, config }) => {
    const [isDragging, setIsDragging] = useState(false);
    const fileInputRef = useRef(null);
    const { uploadedFile, posePrompts } = formData;
    const apiEnabled = config?.apiEnabled;
    const apiKey = config?.apiKey;

    const handleFile = useCallback((file) => {
        if (!file) return;
        if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) { showModal('Format Tidak Sah', 'Sila muat naik fail gambar JPG atau PNG sahaja.'); return; }
        if (uploadedFile) URL.revokeObjectURL(uploadedFile.previewUrl);
        setFormData((prev) => ({...prev, uploadedFile: { file, previewUrl: URL.createObjectURL(file) }}));
    }, [showModal, uploadedFile, setFormData]);

    const handleRemove = (e) => { e.stopPropagation(); setFormData((prev) => ({...prev, uploadedFile: null, posePrompts: null })); };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!apiEnabled) { showModal('Sistem Diselenggara', 'Maaf, servis AI sedang dimatikan oleh Admin untuk penyelenggaraan.'); return; }
        if (!uploadedFile) { showModal('Tiada Gambar', 'Sila muat naik gambar rujukan tema terlebih dahulu.'); return; }
        showLoadingModal('Menjana Variasi...', 'AI sedang mencipta 8 jenis pose profesional & candid...');
        setFormData((prev) => ({...prev, posePrompts: null }));
        try {
            const base64ImageData = await fileToBase64(uploadedFile.file);
            const prompts = await generateBatchPosePrompts(base64ImageData, uploadedFile.file.type, apiKey);
            setFormData((prev) => ({...prev, posePrompts: prompts }));
        } catch (error) { showModal('Ralat', 'Sistem gagal menjana pose.'); } finally { hideLoadingModal(); }
    };

    return (
        <div className="animate-in slide-in-from-right-5 duration-500">
            <div className="flex justify-between items-center mb-6 px-1">
                <h3 className="text-lg font-serif text-slate-200">Variasi Pose & Angle</h3>
                <InfoButton title="Batch Pose"><p>Muat naik gambar tema, dan AI akan menjana 8 variasi prompt berbeza (Candid, Romantic, Artistic, dll) mengikut estetik gambar tersebut.</p></InfoButton>
            </div>
            <form onSubmit={handleSubmit} className="space-y-6">
                <ImageUploadArea uploadedFile={uploadedFile} isDragging={isDragging} onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }} onDragLeave={(e) => { e.preventDefault(); setIsDragging(false); }} onDrop={(e) => { e.preventDefault(); setIsDragging(false); handleFile(e.dataTransfer.files[0]); }} onClick={() => fileInputRef.current?.click()} fileInputRef={fileInputRef} handleFile={handleFile} onRemove={handleRemove} />
                <div className="flex flex-col sm:flex-row gap-3 pt-1">
                    <button type="submit" disabled={!uploadedFile} className={`flex-1 w-full bg-gradient-to-r ${apiEnabled ? 'from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600' : 'from-slate-700 to-slate-800 cursor-not-allowed grayscale'} disabled:opacity-70 text-white font-bold py-3.5 px-6 rounded-xl transition-all duration-300 ease-out flex items-center justify-center gap-2 shadow-lg shadow-amber-900/20 hover:shadow-amber-500/20 hover:-translate-y-0.5 group text-sm`}>
                        {uploadedFile ? <Layers size={18} className="animate-pulse" /> : <ScanFace size={18} />}
                        <span className="tracking-wide">{apiEnabled ? 'JANA 8 VARIASI POSE' : 'SYSTEM OFFLINE'}</span>
                    </button>
                    <button type="button" onClick={onReset} className="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white font-medium py-3.5 px-4 rounded-xl transition duration-300 border border-slate-700 hover:border-slate-500"><RefreshCw size={18} /></button>
                </div>
            </form>
            {posePrompts && (
                <div className="mt-10 space-y-4 animate-in slide-in-from-bottom-10 duration-700">
                    <h2 className="text-sm font-serif text-white flex items-center gap-2 mb-4"><Check className="text-emerald-500" size={16} /> Senarai Batch Prompt (8 Variasi)</h2>
                    {posePrompts.map((item, index) => (
                        <div key={index} className="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4 hover:border-amber-500/30 transition-colors group">
                            <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-amber-500 uppercase tracking-wider">{index + 1}. {item.title}</span><CopyButton textToCopy={item.prompt} label="SALIN" /></div>
                            <p className="font-mono text-xs text-slate-300 leading-relaxed opacity-90">{item.prompt}</p>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
});

// --- SETTINGS MODAL (EMAIL & PASSWORD) ---
const SettingsModal = ({ isOpen, onClose, config, user }) => {
    const [error, setError] = useState('');
    const [isUpdating, setIsUpdating] = useState(false);
    const [apiKeyInput, setApiKeyInput] = useState('');
    const [showKey, setShowKey] = useState(false);
    
    // Login States
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    // Cek jika user adalah admin (Bukan Anonymous)
    const isAdmin = user && !user.isAnonymous;

    useEffect(() => {
        if (isOpen) {
            setError('');
            setApiKeyInput(config?.apiKey || '');
            setEmail('');
            setPassword('');
        }
    }, [isOpen, config]);

    const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // Auth listener will auto-update state
        } catch (err) {
            console.error("Login Error:", err);
            setError("Log masuk gagal. Sila semak emel dan kata laluan.");
        }
    };

    const handleLogout = async () => {
        try {
            await signOut(auth);
            await signInAnonymously(auth); 
        } catch (err) { console.error("Logout Error:", err); }
    };

    const updateConfig = async (shouldEnableSystem) => {
        if (!isAdmin) return;
        setIsUpdating(true);
        
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'system_settings', 'global_config'), {
                apiEnabled: shouldEnableSystem, 
                apiKey: apiKeyInput,
                lastUpdated: new Date().toISOString(),
                updatedBy: user?.email || 'Admin'
            }, { merge: true });
        } catch (err) {
            console.error("Error updating config:", err);
            setError("Gagal menyimpan. Pastikan Firestore Rules anda betul.");
        } finally {
            setIsUpdating(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] flex items-center justify-center p-4 animate-in fade-in zoom-in-95 duration-200">
            <div className="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-white transition-colors"><X size={20} /></button>
                
                <div className="flex flex-col items-center mb-6">
                    <div className="p-3 bg-slate-800 rounded-full mb-3 text-slate-300 border border-slate-700">
                        {isAdmin ? <Settings size={24} className="text-emerald-500" /> : <Lock size={24} />}
                    </div>
                    <h3 className="text-lg font-bold text-white tracking-wide">
                        {isAdmin ? 'Admin Control Panel' : 'Akses Terhad'}
                    </h3>
                    {user && !user.isAnonymous && <p className="text-[10px] text-slate-400 mt-1">{user.email}</p>}
                </div>

                {!isAdmin ? (
                    <form onSubmit={handleLogin} className="space-y-4">
                        <p className="text-sm text-center text-slate-400 mb-2">Log masuk Admin (Email & Password)</p>
                        <div>
                            <input 
                                type="email" 
                                placeholder="Emel Admin" 
                                className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-amber-500 placeholder:text-slate-500"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                            />
                        </div>
                        <div>
                            <input 
                                type="password" 
                                placeholder="Kata Laluan" 
                                className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-amber-500 placeholder:text-slate-500"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                            />
                        </div>
                        <button 
                            type="submit" 
                            className="w-full bg-slate-800 hover:bg-white hover:text-black text-white font-bold py-3 rounded-xl transition-all text-sm flex items-center justify-center gap-2 border border-slate-700 shadow-lg mt-2"
                        >
                            Log Masuk
                        </button>
                        
                        {error && (
                            <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-left mt-2">
                                <p className="text-red-400 text-xs leading-relaxed flex items-start gap-2">
                                    <AlertTriangle size={14} className="mt-0.5 shrink-0" /> {error}
                                </p>
                            </div>
                        )}
                    </form>
                ) : (
                    <div className="space-y-6 animate-in fade-in duration-300">
                        {/* Status Semasa */}
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-full ${config?.apiEnabled ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                                    <Power size={20} />
                                </div>
                                <div>
                                    <h4 className="text-sm font-bold text-white">Status Sistem</h4>
                                    <p className="text-[10px] text-slate-400">{config?.apiEnabled ? 'Online (Semua Pengguna)' : 'Maintenance (Ditutup)'}</p>
                                </div>
                            </div>
                        </div>

                        {/* API Config Form */}
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 space-y-3">
                            <div className="flex items-center gap-2 mb-1">
                                <Key size={14} className="text-amber-500" />
                                <h4 className="text-xs font-bold text-slate-300 uppercase tracking-wide">API Configuration</h4>
                            </div>
                            <div className="relative">
                                <input 
                                    type={showKey ? "text" : "password"}
                                    value={apiKeyInput}
                                    onChange={(e) => setApiKeyInput(e.target.value)}
                                    placeholder="Masukkan API Key"
                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:outline-none focus:border-amber-500 pr-10"
                                />
                                <button type="button" onClick={() => setShowKey(!showKey)} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white">
                                    {showKey ? <EyeOff size={14} /> : <Eye size={14} />}
                                </button>
                            </div>
                            
                            <div className="pt-2 flex flex-col gap-2">
                                <p className="text-[10px] text-slate-500 italic text-center mb-1">Tindakan ini akan mengemaskini API Key dan mengubah status sistem.</p>
                                <button 
                                    onClick={() => updateConfig(false)} 
                                    disabled={isUpdating}
                                    className="w-full flex items-center justify-center gap-2 bg-red-900/80 hover:bg-red-800 text-white py-2.5 rounded-lg text-xs font-bold transition-colors disabled:opacity-50 border border-red-700/50"
                                >
                                    <Power size={14} /> Simpan Config & Matikan Sistem (OFF)
                                </button>
                                <button 
                                    onClick={() => updateConfig(true)} 
                                    disabled={isUpdating}
                                    className="w-full flex items-center justify-center gap-2 bg-emerald-900/80 hover:bg-emerald-800 text-white py-2.5 rounded-lg text-xs font-bold transition-colors disabled:opacity-50 border border-emerald-700/50"
                                >
                                    <Save size={14} /> Simpan Config & Hidupkan Sistem (ON)
                                </button>
                            </div>
                        </div>

                        {error && <p className="text-red-400 text-xs text-center">{error}</p>}
                        
                        <div className="flex justify-between items-center pt-2 border-t border-slate-800 mt-2">
                            <button onClick={handleLogout} className="text-red-400 hover:text-red-300 text-xs flex items-center gap-1 font-medium py-2"><LogOut size={12} /> Log Keluar</button>
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-xs underline py-2">Tutup</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- APP ROOT ---
const AlertModal = ({ show, title, message, onClose }) => {
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-in fade-in duration-300">
      <div className="bg-slate-900 border border-slate-700 rounded-2xl max-w-sm w-full p-6 shadow-2xl transform scale-100 ring-1 ring-white/10">
        <div className="flex items-center gap-3 mb-4"><div className="p-2 bg-red-500/10 rounded-full text-red-400"><Info size={24} /></div><h3 className="text-lg font-bold text-white">{title}</h3></div>
        <p className="text-slate-400 text-sm leading-relaxed mb-6">{message}</p>
        <button onClick={onClose} className="w-full bg-slate-800 hover:bg-slate-700 text-white font-medium py-3 rounded-xl transition-all border border-slate-700 hover:border-slate-600 text-sm">Tutup Mesej</button>
      </div>
    </div>
  );
};

const LoadingModal = ({ show, title, message }) => {
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-slate-950/90 z-50 flex items-center justify-center p-4 animate-in fade-in duration-500 backdrop-blur-sm">
      <div className="flex flex-col items-center text-center max-w-md">
        <div className="relative mb-6"><div className="absolute inset-0 bg-amber-500 blur-xl opacity-20 animate-pulse"></div><Loader2 className="w-16 h-16 text-amber-400 animate-spin relative z-10" /></div>
        <h3 className="text-2xl font-serif text-white mb-3 tracking-wide">{title}</h3>
        <p className="text-slate-400 text-sm animate-pulse tracking-widest uppercase">{message}</p>
      </div>
    </div>
  );
};

export default function App() {
    const [activeTab, setActiveTab] = useState('analyzer');
    const [analyzerData, setAnalyzerData] = useState({ uploadedFile: null, generatedPrompt: '' });
    const [poseData, setPoseData] = useState({ uploadedFile: null, posePrompts: null });
    const [alert, setAlert] = useState({ show: false, title: '', message: '' });
    const [loading, setLoading] = useState({ show: false, title: '', message: '' });
    
    // STATE
    const [showSettings, setShowSettings] = useState(false);
    const [systemConfig, setSystemConfig] = useState({ apiEnabled: true, apiKey: '' });
    const [user, setUser] = useState(null);
    const [authError, setAuthError] = useState(null);

    const showModal = useCallback((title, message) => setAlert({ show: true, title, message }), []);

    useEffect(() => {
        const initAuth = async () => {
             try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
             } catch (error) {
                console.log("Auth Init Fallback:", error.message);
                try { await signInAnonymously(auth); } 
                catch (anonError) { 
                    if (anonError.code?.includes('auth/')) setAuthError(true);
                }
             }
        };
        initAuth();
        const unsubscribeAuth = onAuthStateChanged(auth, setUser);
        return () => unsubscribeAuth();
    }, []);

    // Listen to Config Changes
    useEffect(() => {
        if (!user) return;
        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'system_settings', 'global_config');
        const unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                setSystemConfig({ apiEnabled: data.apiEnabled ?? true, apiKey: data.apiKey ?? '' });
            }
        }, (error) => {
            console.error("Config Listener Error (Permission/Network):", error);
        });
        return () => unsubscribeConfig();
    }, [user]);

    const showLoadingModal = useCallback((title, message) => setLoading({ show: true, title, message }), []);
    const hideLoadingModal = useCallback(() => setLoading(prev => ({ ...prev, show: false })), []);
    const handleResetAnalyzer = useCallback(() => setAnalyzerData({ uploadedFile: null, generatedPrompt: '' }), []);
    const handleResetPose = useCallback(() => setPoseData({ uploadedFile: null, posePrompts: null }), []);

    return (
        <div className="min-h-screen bg-slate-950 text-slate-200 font-sans p-4 md:p-8 selection:bg-amber-500/30 selection:text-amber-200">
            <div className="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-3xl h-64 bg-amber-500/5 blur-[100px] rounded-full pointer-events-none z-0"></div>

            {authError && (
                <div className="fixed top-0 left-0 w-full bg-red-900/90 text-white z-[100] px-4 py-3 flex items-center justify-center gap-3 backdrop-blur-md shadow-2xl border-b border-red-500/30 animate-in slide-in-from-top duration-500">
                    <AlertTriangle className="text-red-300 animate-pulse" size={24} />
                    <div className="text-center"><p className="font-bold text-sm uppercase tracking-wider">Konfigurasi Firebase Diperlukan</p><p className="text-xs text-red-200 mt-1">Sila aktifkan <strong>"Anonymous" & "Email/Password"</strong> di Firebase Console.</p></div>
                    <button onClick={() => setAuthError(false)} className="absolute right-4 top-1/2 -translate-y-1/2 p-2 hover:bg-red-800 rounded-full transition-colors"><X size={16} /></button>
                </div>
            )}

            {/* NEW POSITION: Admin Button Top Left */}
            <button 
                onClick={() => setShowSettings(true)}
                className="fixed top-4 left-4 z-50 text-slate-700 hover:text-amber-500 transition-all p-2 rounded-full hover:bg-slate-900/80"
                title="Admin Access"
            >
                <Settings size={20} />
            </button>

            <div className="relative z-10 max-w-xl mx-auto">
                <AlertModal show={alert.show} title={alert.title} message={alert.message} onClose={() => setAlert(prev => ({ ...prev, show: false }))} />
                <LoadingModal show={loading.show} title={loading.title} message={loading.message} />
                
                <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} config={systemConfig} user={user} />

                <div className="flex flex-col items-center text-center mb-8 space-y-2">
                    <div className="flex items-center justify-center gap-2 mb-2"><Heart className="text-amber-500 fill-amber-500" size={16} /><span className="text-xs font-bold tracking-[0.3em] text-amber-500 uppercase">Sistem Pintar</span></div>
                    <h1 className="text-4xl md:text-5xl font-serif text-white tracking-tight">WARKAH KASIH</h1>
                    <p className="text-slate-400 text-sm font-light tracking-wide max-w-lg mx-auto">Analisis Gaya Kahwin & Penjana Prompt Profesional</p>
                    
                    {!systemConfig.apiEnabled && (
                        <div className="mt-2 px-3 py-1 bg-red-500/10 border border-red-500/20 rounded-full flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                            <span className="text-[10px] text-red-400 font-bold uppercase tracking-wider">SYSTEM OFFLINE</span>
                        </div>
                    )}
                </div>

                <div className="flex p-1 bg-slate-900/80 rounded-2xl mb-8 border border-slate-800 backdrop-blur-sm relative">
                    <button onClick={() => setActiveTab('analyzer')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold transition-all duration-300 ${activeTab === 'analyzer' ? 'bg-slate-800 text-white shadow-lg ring-1 ring-slate-700' : 'text-slate-500 hover:text-slate-300'}`}><Aperture size={16} /> Analisis Style</button>
                    <button onClick={() => setActiveTab('poses')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold transition-all duration-300 ${activeTab === 'poses' ? 'bg-slate-800 text-white shadow-lg ring-1 ring-slate-700' : 'text-slate-500 hover:text-slate-300'}`}><User size={16} /> Variasi Pose</button>
                </div>

                <div className="bg-slate-900/20 rounded-3xl p-1 relative">
                    {!systemConfig.apiEnabled && (
                        <div className="absolute inset-0 bg-slate-950/50 z-10 rounded-3xl pointer-events-none border border-red-500/10 flex items-center justify-center"></div>
                    )}

                    {activeTab === 'analyzer' ? (
                        <StyleAnalyzerTab showModal={showModal} showLoadingModal={showLoadingModal} hideLoadingModal={hideLoadingModal} formData={analyzerData} setFormData={setAnalyzerData} onReset={handleResetAnalyzer} config={systemConfig} />
                    ) : (
                        <PoseGeneratorTab showModal={showModal} showLoadingModal={showLoadingModal} hideLoadingModal={hideLoadingModal} formData={poseData} setFormData={setPoseData} onReset={handleResetPose} config={systemConfig} />
                    )}
                </div>

                <div className="text-center mt-12 pb-8 border-t border-slate-800/50 pt-8 flex flex-col items-center gap-4">
                    <div><p className="text-[10px] font-bold tracking-[0.2em] text-slate-600 mb-2">DIKUASAKAN OLEH</p><p className="text-xs text-slate-500 font-mono">@konten_beban</p></div>
                </div>
            </div>
        </div>
    );
}
